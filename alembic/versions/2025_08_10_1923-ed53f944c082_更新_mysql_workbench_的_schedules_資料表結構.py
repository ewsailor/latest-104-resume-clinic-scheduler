"""更新 MySQL Workbench 的 schedules 資料表結構

Revision ID: ed53f944c082
Revises: 3db1a1b68bc8
Create Date: 2025-08-10 19:23:58.399288

"""

from typing import Sequence, Union

import sqlalchemy as sa
from sqlalchemy.dialects import mysql

from alembic import op

# revision identifiers, used by Alembic.
revision: str = 'ed53f944c082'
down_revision: Union[str, Sequence[str], None] = '3db1a1b68bc8'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column(
        'schedules',
        'id',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment='諮詢時段 ID',
        existing_nullable=False,
        autoincrement=True,
    )
    op.alter_column(
        'schedules',
        'giver_id',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment='Giver 使用者 ID',
        existing_nullable=False,
    )
    op.alter_column(
        'schedules',
        'taker_id',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment='Taker 使用者 ID，可為 NULL（表示 Giver 提供時段供 Taker 預約）',
        existing_nullable=True,
    )
    op.alter_column(
        'schedules',
        'status',
        existing_type=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=20),
        type_=sa.Enum(
            'DRAFT',
            'AVAILABLE',
            'PENDING',
            'ACCEPTED',
            'REJECTED',
            'CANCELLED',
            'COMPLETED',
            name='schedulestatusenum',
        ),
        nullable=False,
        comment='諮詢時段狀態',
        existing_comment='時段狀態',
        existing_server_default=sa.text("'DRAFT'"),
    )
    op.alter_column(
        'schedules',
        'date',
        existing_type=sa.DATE(),
        comment='日期',
        existing_comment='時段日期',
        existing_nullable=False,
    )
    op.alter_column(
        'schedules',
        'note',
        existing_type=mysql.VARCHAR(
            charset='utf8mb4', collation='utf8mb4_unicode_ci', length=255
        ),
        comment='備註，可為空',
        existing_comment='備註',
        existing_nullable=True,
    )
    op.alter_column(
        'schedules',
        'created_at',
        existing_type=mysql.DATETIME(),
        nullable=False,
        comment='建立時間（本地時間）',
        existing_comment='建立時間',
        existing_server_default=sa.text('CURRENT_TIMESTAMP'),
    )
    op.alter_column(
        'schedules',
        'updated_at',
        existing_type=mysql.DATETIME(),
        nullable=False,
        comment='更新時間（本地時間）',
        existing_comment='更新時間',
        existing_server_default=sa.text(
            'CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP'
        ),
    )
    op.alter_column(
        'schedules',
        'updated_by',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment='最後更新的使用者 ID，可為 NULL（表示系統自動更新）',
        existing_nullable=True,
    )
    op.alter_column(
        'schedules',
        'updated_by_role',
        existing_type=mysql.ENUM(
            'GIVER', 'TAKER', 'SYSTEM', collation='utf8mb4_unicode_ci'
        ),
        comment='最後更新者角色',
        existing_comment='最後更新者的角色：GIVER、TAKER 或 SYSTEM',
        existing_nullable=True,
    )
    op.alter_column(
        'schedules',
        'deleted_at',
        existing_type=mysql.DATETIME(),
        comment='軟刪除標記（本地時間）',
        existing_comment='軟刪除標記',
        existing_nullable=True,
    )
    op.drop_index(op.f('ix_schedules_id'), table_name='schedules')
    op.drop_constraint(op.f('schedules_ibfk_1'), 'schedules', type_='foreignkey')
    op.create_foreign_key(
        None, 'schedules', 'users', ['taker_id'], ['id'], ondelete='SET NULL'
    )
    op.alter_column(
        'users',
        'id',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment='使用者 ID',
        existing_nullable=False,
        autoincrement=True,
    )
    op.alter_column(
        'users',
        'created_at',
        existing_type=mysql.DATETIME(),
        comment='建立時間（本地時間）',
        existing_comment='建立時間(本地時間)',
        existing_nullable=False,
        existing_server_default=sa.text('CURRENT_TIMESTAMP'),
    )
    op.alter_column(
        'users',
        'updated_at',
        existing_type=mysql.DATETIME(),
        comment='更新時間（本地時間）',
        existing_comment='更新時間(本地時間)',
        existing_nullable=False,
        existing_server_default=sa.text(
            'CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP'
        ),
    )
    op.alter_column(
        'users',
        'updated_by',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment='最後更新的使用者 ID，可為 NULL（表示系統自動更新）',
        existing_nullable=True,
    )
    op.alter_column(
        'users',
        'deleted_at',
        existing_type=mysql.DATETIME(),
        comment='軟刪除標記（本地時間）',
        existing_comment='軟刪除標記(本地時間)',
        existing_nullable=True,
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column(
        'users',
        'deleted_at',
        existing_type=mysql.DATETIME(),
        comment='軟刪除標記(本地時間)',
        existing_comment='軟刪除標記（本地時間）',
        existing_nullable=True,
    )
    op.alter_column(
        'users',
        'updated_by',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment=None,
        existing_comment='最後更新的使用者 ID，可為 NULL（表示系統自動更新）',
        existing_nullable=True,
    )
    op.alter_column(
        'users',
        'updated_at',
        existing_type=mysql.DATETIME(),
        comment='更新時間(本地時間)',
        existing_comment='更新時間（本地時間）',
        existing_nullable=False,
        existing_server_default=sa.text(
            'CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP'
        ),
    )
    op.alter_column(
        'users',
        'created_at',
        existing_type=mysql.DATETIME(),
        comment='建立時間(本地時間)',
        existing_comment='建立時間（本地時間）',
        existing_nullable=False,
        existing_server_default=sa.text('CURRENT_TIMESTAMP'),
    )
    op.alter_column(
        'users',
        'id',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment=None,
        existing_comment='使用者 ID',
        existing_nullable=False,
        autoincrement=True,
    )
    op.drop_constraint(None, 'schedules', type_='foreignkey')
    op.create_foreign_key(
        op.f('schedules_ibfk_1'), 'schedules', 'users', ['taker_id'], ['id']
    )
    op.create_index(op.f('ix_schedules_id'), 'schedules', ['id'], unique=False)
    op.alter_column(
        'schedules',
        'deleted_at',
        existing_type=mysql.DATETIME(),
        comment='軟刪除標記',
        existing_comment='軟刪除標記（本地時間）',
        existing_nullable=True,
    )
    op.alter_column(
        'schedules',
        'updated_by_role',
        existing_type=mysql.ENUM(
            'GIVER', 'TAKER', 'SYSTEM', collation='utf8mb4_unicode_ci'
        ),
        comment='最後更新者的角色：GIVER、TAKER 或 SYSTEM',
        existing_comment='最後更新者角色',
        existing_nullable=True,
    )
    op.alter_column(
        'schedules',
        'updated_by',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment=None,
        existing_comment='最後更新的使用者 ID，可為 NULL（表示系統自動更新）',
        existing_nullable=True,
    )
    op.alter_column(
        'schedules',
        'updated_at',
        existing_type=mysql.DATETIME(),
        nullable=True,
        comment='更新時間',
        existing_comment='更新時間（本地時間）',
        existing_server_default=sa.text(
            'CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP'
        ),
    )
    op.alter_column(
        'schedules',
        'created_at',
        existing_type=mysql.DATETIME(),
        nullable=True,
        comment='建立時間',
        existing_comment='建立時間（本地時間）',
        existing_server_default=sa.text('CURRENT_TIMESTAMP'),
    )
    op.alter_column(
        'schedules',
        'note',
        existing_type=mysql.VARCHAR(
            charset='utf8mb4', collation='utf8mb4_unicode_ci', length=255
        ),
        comment='備註',
        existing_comment='備註，可為空',
        existing_nullable=True,
    )
    op.alter_column(
        'schedules',
        'date',
        existing_type=sa.DATE(),
        comment='時段日期',
        existing_comment='日期',
        existing_nullable=False,
    )
    op.alter_column(
        'schedules',
        'status',
        existing_type=sa.Enum(
            'DRAFT',
            'AVAILABLE',
            'PENDING',
            'ACCEPTED',
            'REJECTED',
            'CANCELLED',
            'COMPLETED',
            name='schedulestatusenum',
        ),
        type_=mysql.VARCHAR(collation='utf8mb4_unicode_ci', length=20),
        nullable=True,
        comment='時段狀態',
        existing_comment='諮詢時段狀態',
        existing_server_default=sa.text("'DRAFT'"),
    )
    op.alter_column(
        'schedules',
        'taker_id',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment=None,
        existing_comment='Taker 使用者 ID，可為 NULL（表示 Giver 提供時段供 Taker 預約）',
        existing_nullable=True,
    )
    op.alter_column(
        'schedules',
        'giver_id',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment=None,
        existing_comment='Giver 使用者 ID',
        existing_nullable=False,
    )
    op.alter_column(
        'schedules',
        'id',
        existing_type=mysql.INTEGER(display_width=10, unsigned=True),
        comment=None,
        existing_comment='諮詢時段 ID',
        existing_nullable=False,
        autoincrement=True,
    )
    # ### end Alembic commands ###
